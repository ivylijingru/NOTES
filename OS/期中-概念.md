## 操作系统概述
### 操作系统定义
- 计算机系统中的系统软件，能够
  - 以**有效、合理**的方式组织和管理计算机的软硬件资源；（资源管理者）
  - **合理**组织计算机工作流程，控制程序执行并向用户提供各种服务；（服务提供者）
  - 使用户更灵活、**方便**地使用计算机，使计算机系统高效运行。（计算机的扩展）
### 操作系统的特征
- 并发性：处理多个同时性活动的能力。引发问题：活动切换、**保护**（互斥）、相互依赖活动间的**同步**（保证时间顺序）。
- 共享性：多个用户程序共同使用计算机系统中的**资源**。资源有限；操作系统进行合理分配；在一个时间段内交替被进程使用。分为互斥共享（临界区、打印机），同时访问（磁盘文件、可重入代码，即任何变量都是局部变量，多个进程同时访问而结果不受影响）。
- 虚拟性：**一个物理实体**映射为**若干个对应的逻辑实体**——分时、分空间。（CPU对应进程虚处理器，存储器对应地址空间）
- 随机性：对次序不可预测地发生的事件进行相应。进程运行速度不可预知，某个状态难以重现。
### OS 历史
- 批处理操作系统问题：慢速输入输出直接由主机完成（主机与设备交互），输入输出时 CPU 等待。从提交到出结果要很长时间。
- OS/360
  - SPOOLing 技术（假脱机）：磁盘放置**输入井、输出井**，二者与输入输出设备进行交互，而主机与之独立运行，可从输入井读、写入输出井。（提供两个暂时存储的地方）
  - 该技术应用：要打印的文件记录在打印请求队列，交给打印进程 daemon 与打印机交互。
  - 多道程序设计：多个程序并发，使用外围设备的进程和使用 CPU 的进程同时进行。
- MULTICS：支持数百名用户的分时机器。
- 操作系统结构
## 运行环境和运行机制
- CPU 状态
  - 两类寄存器，用户可见寄存器（data/address/condition code）、控制和状态寄存器（Program Counter/Instruction Register/Program Status Word PSW 记录运行状态，如条件码、**模式**、控制位）
  - 状态分内核态、用户态。
- 特权指令：只能由操作系统使用、用户不能使用。（启动 I/O、内存清零、修改 PSW、时钟、允许/禁止中断、停机）
- 非特权指令：用户程序可以使用。（访管指令，叫这个名字因为OS是“管理者”）
- 内核态/用户态；管态、目态；R0，R3
  - 用户 -> 内核：中断/异常/陷入
  - 内核 -> 用户：设置状态字 PSW
### 中断与异常
- 中断：支持 CPU 和设备之间的并行操作。设备完成输入输出后发中断。
- 异常：CPU 执行指令时本身出现的问题，由正在执行的指令引发。
- 处理方法：暂停正在执行的程序，**保留现场**后转去该事件的**处理程序**，处理完成后回到断点，**继续执行**。
- 硬件负责：保存现场（在系统栈中压入`PSW，PC`）；用中断部件响应中断；按规定编码送入 PSW 的相应位，称为中断码；**硬件执行流程**：按中断号/异常类型的不同，通过中断向量表转移控制权给中断处理程序
- 中断向量表
  - 中断向量：存放**中断处理程序入口地址**、程序运行所需**处理机状态字**
- 中断描述符
- 系统调用（运行机制）
- 机制与策略
- 中断执行过程
  - （硬件）
  - 设备给 CPU 发信号
  - CPU 检测中断、判断中断来源
  - 切换到内核态
  - 保存上下文环境（PC、PSW）
  - 根据中断码查中断向量表，获得该中断的入口地址，切换到中断处理程序
  - （软件）
  - 处理程序在系统栈中保存现场
  - 操纵 I/O 设备
  - （硬件）
  - 检测到中断返回指令，恢复原程序的上下文环境
- 系统调用执行过程
  - 中断/异常机制：切换到内核栈；硬件保护现场（PSW，PC）；压入系统调用号；以此为参数，查中断向量表把控制权交给系统调用**总入口程序**
  - 系统调用总入口程序：保存现场（其他寄存器）；将（存储在寄存器中的）参数保存在内核堆栈里；查**系统调用表**把控制权交给系统调用处理程序或内核函数
  - 执行系统调用程序
  - 返回到用户程序
## 进程线程模型
### 进程
- 定义：具有独立功能的程序关于**某个数据集合**上的**一次运行活动**，系统进行资源分配、调度的单位。
- 进程状态及状态转换：**五状态**——创建，就绪，运行，阻塞（等待），终止。**七状态**——再加上就绪挂起、阻塞挂起（将进程转移到外存中）
- 进程控制：通过 PCB 控制、管理进程；进程表：所有进程 PCB 集合；进程控制完成各状态间转换，由**原语**（执行过程中不可打断）完成。例如 `fork()`，进程建立过程 `exec()`，转换进程代码的转换 `wait()`， 使一个进程等待直到另外一个进程结束 `exit()`，终止一个进程的运行
- 进程控制块 process control block：进程描述信息；进程控制信息（状态、优先级、代码执行入口地址、运行统计信息，如执行时间、进程间同步和通信）；拥有的资源和使用情况（虚拟地址空间、打开文件列表）；CPU 现场信息（寄存器值、内核栈）
- 进程地址空间：栈、堆、数据段、代码段（PC）
- 进程映像：程序、数据、栈、PCB
### 线程
- 线程属性：资源的拥有者（虚拟地址空间、资源、保护）；调度单位（状态转换、保存上下文、优先级）；有自己的栈和指针，大部分资源共用。
- Web 服务器：网页缓存中若没有，则进入到磁盘中，被阻塞。建立多个 worker thread，一个 worker 等磁盘时其他 worker 还能工作。
- 用户级线程：用户空间建立线程库，提供**管理线程**的函数。
  - 优点：线程切换快、调度算法应用程序定、用户线程可运行在任何OS
  - 缺点：因系统调用阻塞线程，进程中所有线程也被阻塞；不能运行于多处理器（内核把CPU分配给进程）
- Pthreads `Pthread_create` 创建新线程；`Pthread_exit` 终止线程；`Pthread_join` 等待一个线程终止（之后再运行，因为无法抢占）；`Pthread_yield` 主动放弃 CPU（无法抢占）；`Pthread_attr_init` 创建线程属性结构；`Pthread_attr_destroy` 删除属性结构；
- 核心级线程：线程切换需要内核支持，以线程为基础进行调度。
- 可再入程序：可被多个进程同时调用的程序，调用它的进程提供数据区（不使用共享数据段）

